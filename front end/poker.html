<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Grind Sheet</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

                body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #2c2c2c;
            min-height: 100vh;
            color: #2c2c2c;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: #2c2c2c;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 2px solid #d4af37;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #2c2c2c;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .logo-icon {
            position: relative;
            width: 60px;
            height: 60px;
        }

        .logo-document {
            position: absolute;
            width: 50px;
            height: 60px;
            background: #808080;
            border-radius: 3px;
            transform: rotate(-2deg);
        }

        .logo-document::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 15px;
            height: 15px;
            background: #f5f5dc;
            border-radius: 0 3px 0 0;
        }

        .logo-document .line1 {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 25px;
            height: 2px;
            background: #f5f5dc;
            border-radius: 1px;
        }

        .logo-document .line2 {
            position: absolute;
            top: 12px;
            left: 8px;
            width: 20px;
            height: 2px;
            background: #f5f5dc;
            border-radius: 1px;
        }

        .logo-document .line3 {
            position: absolute;
            top: 16px;
            left: 8px;
            width: 15px;
            height: 2px;
            background: #f5f5dc;
            border-radius: 1px;
        }

        .logo-chip {
            position: absolute;
            bottom: 5px;
            left: 5px;
            width: 25px;
            height: 25px;
            background: #dc143c;
            border-radius: 50%;
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            font-weight: bold;
        }

        .logo-text {
            display: flex;
            flex-direction: column;
            font-weight: bold;
            font-size: 1.8em;
            color: #808080;
            line-height: 0.9;
        }

        .logo-text .the {
            font-size: 0.6em;
            color: #666;
        }

        .logo-text .grind {
            font-size: 1.2em;
        }

        .logo-text .sheet {
            font-size: 1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
            border: 1px solid #e0e0e0;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(220, 20, 60, 0.15);
            border-color: #dc143c;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .positive { color: #27ae60; }
        .negative { color: #dc143c; }
        .neutral { color: #2c2c2c; }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }

        .card h2 {
            margin-bottom: 20px;
            color: #2c2c2c;
            border-bottom: 3px solid #dc143c;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #dc143c;
        }

        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .leak-categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 5px;
        }

        .leak-category-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }

        .leak-category-item:hover {
            background: #e9ecef;
        }

        .btn {
            background: linear-gradient(135deg, #dc143c, #b22222);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 20, 60, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc143c, #b22222);
        }

        .chart-container {
            grid-column: 1 / -1;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            height: 400px;
            border: 1px solid #e0e0e0;
        }

        .sessions-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .session-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border-left: 4px solid #dc143c;
            position: relative;
        }

        .session-item.profit {
            border-left-color: #27ae60;
        }

        .session-item.loss {
            border-left-color: #dc143c;
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .session-date {
            font-weight: 600;
            color: #2c3e50;
        }

        .session-result {
            font-weight: bold;
            font-size: 1.1em;
        }

        .delete-session {
            background: #dc143c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .goals-section {
            grid-column: 1 / -1;
        }

        .goal-item {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .goal-progress {
            background: #e0e0e0;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .goal-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            transition: width 0.5s ease;
        }

        .progress-text {
            text-align: center;
            margin-top: 5px;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div class="logo-container">
                        <div class="logo-icon">
                            <div class="logo-document">
                                <div class="line1"></div>
                                <div class="line2"></div>
                                <div class="line3"></div>
                            </div>
                            <div class="logo-chip">♠</div>
                        </div>
                        <div class="logo-text">
                            <span class="the">THE</span>
                            <span class="grind">GRIND</span>
                            <span class="sheet">SHEET</span>
                        </div>
                    </div>
                    <p>Track your sessions, analyze your performance, and achieve your goals</p>
                </div>
                <div style="text-align: right;">
                    <div id="userInfo" style="margin-bottom: 10px;"></div>
                    <button class="btn btn-secondary" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value neutral" id="totalBankroll">$0</div>
                <div>Current Bankroll</div>
            </div>
            <div class="stat-card">
                <div class="stat-value neutral" id="totalSessions">0</div>
                <div>Total Sessions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value neutral" id="winRate">0%</div>
                <div>Win Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-value neutral" id="avgSession">$0</div>
                <div>Avg Session</div>
            </div>
        </div>

        <div class="chart-container">
            <h2>Bankroll Progress</h2>
            <canvas id="bankrollChart"></canvas>
        </div>

        <div class="main-content">
            <div class="card">
                <h2>Add New Session</h2>
                <form id="sessionForm">
                    <div class="form-group">
                        <label for="sessionDate">Date:</label>
                        <input type="date" id="sessionDate" name="sessionDate" required>
                    </div>
                    <div class="form-group">
                        <label for="gameType">Game Type:</label>
                        <select id="gameType" name="gameType" required>
                            <option value="">Select Game</option>
                            <option value="Cash Game">Cash Game</option>
                            <option value="Tournament">Tournament</option>
                            <option value="Sit & Go">Sit & Go</option>
                            <option value="Online">Online</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="stakes">Stakes:</label>
                        <input type="text" id="stakes" name="stakes" placeholder="e.g., $1/$2, $50 buy-in" required>
                    </div>
                    <div class="form-group">
                        <label for="duration">Duration (hours):</label>
                        <input type="number" id="duration" name="duration" step="0.5" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="result">Result ($):</label>
                        <input type="number" id="result" name="result" step="0.01" placeholder="Enter profit/loss" required>
                    </div>
                    <div class="form-group">
                        <label for="notes">Session Notes:</label>
                        <textarea id="notes" name="notes" rows="4" placeholder="Detailed session notes, key hands, observations, table dynamics..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="leakCategories">Leak Categories:</label>
                        <div class="leak-categories-grid">
                            <label class="leak-category-item">
                                <input type="checkbox" name="leakCategories" value="bluffing"> Bluffing
                            </label>
                            <label class="leak-category-item">
                                <input type="checkbox" name="leakCategories" value="calling"> Calling Too Much
                            </label>
                            <label class="leak-category-item">
                                <input type="checkbox" name="leakCategories" value="folding"> Folding Too Much
                            </label>
                            <label class="leak-category-item">
                                <input type="checkbox" name="leakCategories" value="position"> Position Play
                            </label>
                            <label class="leak-category-item">
                                <input type="checkbox" name="leakCategories" value="bankroll"> Bankroll Management
                            </label>
                            <label class="leak-category-item">
                                <input type="checkbox" name="leakCategories" value="tilt"> Tilt Control
                            </label>
                            <label class="leak-category-item">
                                <input type="checkbox" name="leakCategories" value="timing"> Timing Tells
                            </label>
                            <label class="leak-category-item">
                                <input type="checkbox" name="leakCategories" value="bet-sizing"> Bet Sizing
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="customLeaks">Custom Leak Categories:</label>
                        <input type="text" id="customLeaks" name="customLeaks" placeholder="Add custom leak categories (comma-separated)">
                    </div>
                    <div class="form-group">
                        <label for="keyHands">Key Hands:</label>
                        <textarea id="keyHands" name="keyHands" rows="3" placeholder="Describe important hands, decisions made, and outcomes..."></textarea>
                    </div>
                    <button type="submit" class="btn">Add Session</button>
                </form>
            </div>

            <div class="card">
                <h2>Recent Sessions</h2>
                <div class="sessions-list" id="sessionsList">
                    <p style="text-align: center; color: #666;">No sessions recorded yet</p>
                </div>
            </div>

            <div class="card">
                <h2>Session Notes & Leak Analysis</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3>Leak Pattern Analysis</h3>
                        <div id="leakAnalysis" style="background: #f8f9fa; padding: 15px; border-radius: 8px; min-height: 200px;">
                            <p style="text-align: center; color: #666;">No leak data available yet</p>
                        </div>
                    </div>
                    <div>
                        <h3>Detailed Session Notes</h3>
                        <div id="detailedNotes" style="background: #f8f9fa; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto;">
                            <p style="text-align: center; color: #666;">No detailed notes available yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card goals-section">
            <h2>Bankroll Goals</h2>
            <form id="goalForm" style="margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: end;">
                    <div class="form-group">
                        <label for="goalAmount">Target Amount ($):</label>
                        <input type="number" id="goalAmount" name="goalAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="goalDeadline">Target Date:</label>
                        <input type="date" id="goalDeadline" name="goalDeadline" required>
                    </div>
                    <div class="form-group">
                        <label for="goalDescription">Description:</label>
                        <input type="text" id="goalDescription" name="goalDescription" placeholder="e.g., WSOP Entry" required>
                    </div>
                    <button type="submit" class="btn">Add Goal</button>
                </div>
            </form>
            <div id="goalsList"></div>
        </div>

        <div class="card" style="margin-bottom: 30px;">
            <h2>Bankroll Management</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h3>Set Starting Bankroll</h3>
                    <form id="startingBankrollForm">
                        <div class="form-group">
                            <label for="startingBankroll">Starting Bankroll ($):</label>
                            <input type="number" id="startingBankroll" name="startingBankroll" step="0.01" min="0" placeholder="Enter your starting bankroll">
                        </div>
                        <button type="submit" class="btn">Set Starting Bankroll</button>
                    </form>
                </div>
                <div>
                    <h3>Bankroll Transactions</h3>
                    <form id="transactionForm">
                        <div class="form-group">
                            <label for="transactionType">Transaction Type:</label>
                            <select id="transactionType" name="transactionType" required>
                                <option value="">Select Type</option>
                                <option value="add">Add to Bankroll</option>
                                <option value="remove">Remove from Bankroll</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="transactionAmount">Amount ($):</label>
                            <input type="number" id="transactionAmount" name="transactionAmount" step="0.01" min="0" placeholder="Enter amount" required>
                        </div>
                        <div class="form-group">
                            <label for="transactionReason">Reason:</label>
                            <textarea id="transactionReason" name="transactionReason" rows="2" placeholder="Why is this transaction happening?" required></textarea>
                        </div>
                        <button type="submit" class="btn">Add Transaction</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="card" style="margin-bottom: 30px;">
            <h2>Bankroll Transactions History</h2>
            <div class="sessions-list" id="transactionsList">
                <p style="text-align: center; color: #666;">No transactions recorded yet</p>
            </div>
        </div>

        <div class="card" style="margin-bottom: 30px;">
            <h2>Data Management</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h3>Export Data</h3>
                    <p style="margin-bottom: 15px; color: #666;">Download your data as a backup file</p>
                    <button class="btn" onclick="tracker.exportData()">Export All Data</button>
                </div>
                <div>
                    <h3>Import Data</h3>
                    <p style="margin-bottom: 15px; color: #666;">Restore data from a backup file</p>
                    <input type="file" id="importFile" accept=".json" style="margin-bottom: 10px;">
                    <button class="btn" onclick="tracker.importData()">Import Data</button>
                </div>
            </div>
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h4>Data Storage Information</h4>
                <p><strong>Current Storage:</strong> <span id="storageStatus">Checking...</span></p>
                <p><strong>Last Saved:</strong> <span id="lastSaved">Never</span></p>
                <p style="color: #666; font-size: 14px;">Your data is automatically saved to the server. This data persists across all devices and browsers when you log in with your account.</p>
            </div>
        </div>
    </div>

    <script>
        class PokerTracker {
            constructor() {
                this.sessions = [];
                this.goals = [];
                this.transactions = [];
                this.chart = null;
                this.authToken = localStorage.getItem('authToken');
                
                if (!this.authToken) {
                    window.location.href = '/';
                    return;
                }
                
                this.loadData();
                this.setupEventListeners();
                
                // Set today's date as default
                document.getElementById('sessionDate').valueAsDate = new Date();
                
                // Display user info
                this.displayUserInfo();
            }

            async loadData() {
                try {
                    const response = await fetch('/api/data', {
                        headers: {
                            'Authorization': `Bearer ${this.authToken}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.sessions = data.sessions || [];
                        this.goals = data.goals || [];
                        this.transactions = data.transactions || [];
                    } else if (response.status === 401 || response.status === 403) {
                        // Token expired or invalid
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('userEmail');
                        window.location.href = '/';
                        return;
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                }

                this.initChart();
                this.updateStats();
                this.renderSessions();
                this.renderGoals();
                this.renderTransactions();
                this.renderLeakAnalysis();
                this.renderDetailedNotes();
                this.updateStorageStatus();
            }

            displayUserInfo() {
                const userEmail = localStorage.getItem('userEmail');
                const userInfoElement = document.getElementById('userInfo');
                if (userEmail) {
                    userInfoElement.innerHTML = `<strong>Welcome, ${userEmail}</strong>`;
                }
            }

            setupEventListeners() {
                document.getElementById('sessionForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addSession();
                });

                document.getElementById('goalForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addGoal();
                });

                document.getElementById('startingBankrollForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.setStartingBankroll();
                });

                document.getElementById('transactionForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addTransaction();
                });
            }

            async addSession() {
                const form = document.getElementById('sessionForm');
                const formData = new FormData(form);
                
                // Get selected leak categories
                const leakCheckboxes = form.querySelectorAll('input[name="leakCategories"]:checked');
                const leakCategories = Array.from(leakCheckboxes).map(cb => cb.value);
                
                // Get custom leaks
                const customLeaks = formData.get('customLeaks');
                if (customLeaks && customLeaks.trim()) {
                    const customLeakArray = customLeaks.split(',').map(leak => leak.trim()).filter(leak => leak);
                    leakCategories.push(...customLeakArray);
                }
                
                const session = {
                    id: Date.now(),
                    date: formData.get('sessionDate'),
                    gameType: formData.get('gameType'),
                    stakes: formData.get('stakes'),
                    duration: parseFloat(formData.get('duration')),
                    result: parseFloat(formData.get('result')),
                    notes: formData.get('notes'),
                    leakCategories: leakCategories,
                    keyHands: formData.get('keyHands')
                };

                this.sessions.push(session);
                this.sessions.sort((a, b) => new Date(b.date) - new Date(a.date));
                await this.saveData();
                this.updateStats();
                this.renderSessions();
                this.renderLeakAnalysis();
                this.renderDetailedNotes();
                this.updateChart();
                form.reset();
                document.getElementById('sessionDate').valueAsDate = new Date();
            }

            async deleteSession(id) {
                if (confirm('Are you sure you want to delete this session?')) {
                    this.sessions = this.sessions.filter(session => session.id !== id);
                    await this.saveData();
                    this.updateStats();
                    this.renderSessions();
                    this.renderLeakAnalysis();
                    this.renderDetailedNotes();
                    this.updateChart();
                }
            }

            async addGoal() {
                const form = document.getElementById('goalForm');
                const formData = new FormData(form);
                
                const goal = {
                    id: Date.now(),
                    amount: parseFloat(formData.get('goalAmount')),
                    deadline: formData.get('goalDeadline'),
                    description: formData.get('goalDescription'),
                    startingBankroll: this.getCurrentBankroll()
                };

                this.goals.push(goal);
                await this.saveData();
                this.renderGoals();
                form.reset();
            }

            async deleteGoal(id) {
                if (confirm('Are you sure you want to delete this goal?')) {
                    this.goals = this.goals.filter(goal => goal.id !== id);
                    await this.saveData();
                    this.renderGoals();
                }
            }

            async setStartingBankroll() {
                const form = document.getElementById('startingBankrollForm');
                const formData = new FormData(form);
                const amount = parseFloat(formData.get('startingBankroll'));
                
                if (!isNaN(amount) && amount >= 0) {
                    this.transactions.push({
                        id: Date.now(),
                        date: new Date().toISOString().slice(0, 10),
                        type: 'starting_bankroll',
                        amount: amount,
                        reason: 'Initial bankroll set'
                    });
                    await this.saveData();
                    this.updateStats();
                    this.renderTransactions();
                    this.updateChart();
                    form.reset();
                    alert('Starting bankroll set successfully!');
                } else {
                    alert('Please enter a valid positive number for the starting bankroll.');
                }
            }

            async addTransaction() {
                const form = document.getElementById('transactionForm');
                const formData = new FormData(form);
                
                const type = formData.get('transactionType');
                const amount = parseFloat(formData.get('transactionAmount'));
                const reason = formData.get('transactionReason');

                if (isNaN(amount) || amount <= 0) {
                    alert('Please enter a valid positive amount for the transaction.');
                    return;
                }

                if (!reason.trim()) {
                    alert('Please provide a reason for the transaction.');
                    return;
                }

                const transaction = {
                    id: Date.now(),
                    date: new Date().toISOString().slice(0, 10),
                    type: type,
                    amount: amount,
                    reason: reason.trim()
                };

                this.transactions.push(transaction);
                this.transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                await this.saveData();
                this.updateStats();
                this.renderTransactions();
                this.updateChart();
                form.reset();
                alert(`Transaction added successfully! Amount: ${this.formatCurrency(amount)}`);
            }

            async deleteTransaction(id) {
                if (confirm('Are you sure you want to delete this transaction?')) {
                    this.transactions = this.transactions.filter(tx => tx.id !== id);
                    await this.saveData();
                    this.updateStats();
                    this.renderTransactions();
                }
            }

            getCurrentBankroll() {
                // Calculate from transactions
                const transactionTotal = this.transactions.reduce((total, tx) => {
                    if (tx.type === 'starting_bankroll') return total + tx.amount;
                    if (tx.type === 'add') return total + tx.amount;
                    if (tx.type === 'remove') return total - tx.amount;
                    return total;
                }, 0);
                
                // Add session results
                const sessionTotal = this.sessions.reduce((total, session) => {
                    return total + session.result;
                }, 0);
                
                return transactionTotal + sessionTotal;
            }

            updateStats() {
                const currentBankroll = this.getCurrentBankroll();
                const totalSessions = this.sessions.length;
                const winningSessions = this.sessions.filter(s => s.result > 0).length;
                const winRate = totalSessions > 0 ? (winningSessions / totalSessions * 100) : 0;
                
                // Calculate average session based only on poker session results, not total bankroll
                const totalSessionResults = this.sessions.reduce((sum, session) => sum + session.result, 0);
                const avgSession = totalSessions > 0 ? (totalSessionResults / totalSessions) : 0;

                document.getElementById('totalBankroll').textContent = this.formatCurrency(currentBankroll);
                document.getElementById('totalBankroll').className = `stat-value ${currentBankroll >= 0 ? 'positive' : 'negative'}`;
                
                document.getElementById('totalSessions').textContent = totalSessions;
                document.getElementById('winRate').textContent = winRate.toFixed(1) + '%';
                document.getElementById('avgSession').textContent = this.formatCurrency(avgSession);
                document.getElementById('avgSession').className = `stat-value ${avgSession >= 0 ? 'positive' : 'negative'}`;
            }

            renderSessions() {
                const container = document.getElementById('sessionsList');
                
                if (this.sessions.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">No sessions recorded yet</p>';
                    return;
                }

                container.innerHTML = this.sessions.slice(0, 10).map(session => {
                    const hasLeaks = session.leakCategories && session.leakCategories.length > 0;
                    const hasKeyHands = session.keyHands && session.keyHands.trim();
                    
                    return `
                        <div class="session-item ${session.result >= 0 ? 'profit' : 'loss'}">
                            <div class="session-header">
                                <span class="session-date">${new Date(session.date).toLocaleDateString()}</span>
                                <span class="session-result ${session.result >= 0 ? 'positive' : 'negative'}">
                                    ${this.formatCurrency(session.result)}
                                </span>
                                <button class="delete-session" onclick="tracker.deleteSession(${session.id})">×</button>
                            </div>
                            <div><strong>${session.gameType}</strong> - ${session.stakes}</div>
                            <div>Duration: ${session.duration}h</div>
                            ${session.notes ? `<div style="margin-top: 8px; font-style: italic; color: #666;">${session.notes}</div>` : ''}
                            ${hasLeaks ? `<div style="margin-top: 5px; font-size: 12px; color: #dc143c;"><strong>Leaks:</strong> ${session.leakCategories.join(', ')}</div>` : ''}
                            ${hasKeyHands ? `<div style="margin-top: 5px; font-size: 12px; color: #f39c12;"><strong>Key Hands:</strong> ${session.keyHands.substring(0, 50)}${session.keyHands.length > 50 ? '...' : ''}</div>` : ''}
                        </div>
                    `;
                }).join('');
            }

            renderGoals() {
                const container = document.getElementById('goalsList');
                const currentBankroll = this.getCurrentBankroll();
                
                if (this.goals.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">No goals set yet</p>';
                    return;
                }

                container.innerHTML = this.goals.map(goal => {
                    const progress = Math.max(0, currentBankroll - goal.startingBankroll);
                    const needed = goal.amount - goal.startingBankroll;
                    const progressPercent = needed > 0 ? Math.min(100, (progress / needed) * 100) : 0;
                    const daysLeft = Math.ceil((new Date(goal.deadline) - new Date()) / (1000 * 60 * 60 * 24));
                    const remaining = Math.max(0, goal.amount - currentBankroll);

                    return `
                        <div class="goal-item">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h3>${goal.description}</h3>
                                <button class="btn btn-danger" onclick="tracker.deleteGoal(${goal.id})" style="padding: 5px 10px; font-size: 12px;">Delete</button>
                            </div>
                            <div>Target: ${this.formatCurrency(goal.amount)} by ${new Date(goal.deadline).toLocaleDateString()}</div>
                            <div>Remaining: ${this.formatCurrency(remaining)} (${daysLeft} days left)</div>
                            <div class="goal-progress">
                                <div class="goal-progress-bar" style="width: ${progressPercent}%"></div>
                            </div>
                            <div class="progress-text">${progressPercent.toFixed(1)}% Complete</div>
                            ${remaining > 0 && daysLeft > 0 ? 
                                `<div style="margin-top: 5px; color: #666;">Need ${this.formatCurrency(remaining / daysLeft)}/day to reach goal</div>` 
                                : ''}
                        </div>
                    `;
                }).join('');
            }

            renderTransactions() {
                const container = document.getElementById('transactionsList');
                if (this.transactions.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">No transactions recorded yet</p>';
                    return;
                }

                container.innerHTML = this.transactions.map(tx => {
                    const date = new Date(tx.date);
                    const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
                    const amount = this.formatCurrency(tx.amount);
                    const typeClass = tx.type === 'add' ? 'positive' : 'negative';
                    const typeText = tx.type === 'add' ? 'Added' : 'Removed';

                    return `
                        <div class="session-item ${typeClass}">
                            <div class="session-header">
                                <span class="session-date">${formattedDate}</span>
                                <span class="session-result ${typeClass}">${amount}</span>
                                <button class="delete-session" onclick="tracker.deleteTransaction(${tx.id})">×</button>
                            </div>
                            <div>${typeText} ${amount} for reason: "${tx.reason}"</div>
                        </div>
                    `;
                }).join('');
            }

            renderLeakAnalysis() {
                const container = document.getElementById('leakAnalysis');
                const sessionsWithLeaks = this.sessions.filter(session => session.leakCategories && session.leakCategories.length > 0);
                
                if (sessionsWithLeaks.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">No leak data available yet</p>';
                    return;
                }

                // Count leak occurrences
                const leakCounts = {};
                sessionsWithLeaks.forEach(session => {
                    session.leakCategories.forEach(leak => {
                        leakCounts[leak] = (leakCounts[leak] || 0) + 1;
                    });
                });

                // Sort leaks by frequency
                const sortedLeaks = Object.entries(leakCounts)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5); // Top 5 leaks

                const leakHTML = sortedLeaks.map(([leak, count]) => {
                    const percentage = ((count / sessionsWithLeaks.length) * 100).toFixed(1);
                    return `
                        <div style="margin-bottom: 10px; padding: 8px; background: white; border-radius: 5px; border-left: 3px solid #dc143c;">
                            <div style="font-weight: bold; color: #dc143c;">${leak}</div>
                            <div style="font-size: 12px; color: #666;">Occurred in ${count} sessions (${percentage}%)</div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <strong>Most Common Leaks (Last ${sessionsWithLeaks.length} Sessions):</strong>
                    </div>
                    ${leakHTML}
                    <div style="margin-top: 15px; font-size: 12px; color: #666;">
                        <strong>Tip:</strong> Focus on improving your most frequent leaks first to see the biggest improvement in your win rate.
                    </div>
                `;
            }



            renderDetailedNotes() {
                const container = document.getElementById('detailedNotes');
                const sessionsWithNotes = this.sessions.filter(session => 
                    (session.notes && session.notes.trim()) || 
                    (session.keyHands && session.keyHands.trim())
                );
                
                if (sessionsWithNotes.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">No detailed notes available yet</p>';
                    return;
                }

                const notesHTML = sessionsWithNotes.slice(0, 5).map(session => {
                    const date = new Date(session.date).toLocaleDateString();
                    const resultClass = session.result >= 0 ? 'positive' : 'negative';
                    
                    return `
                        <div style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 5px; border: 1px solid #e0e0e0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong>${date} - ${session.gameType}</strong>
                                <span class="${resultClass}">${this.formatCurrency(session.result)}</span>
                            </div>
                            ${session.notes ? `<div style="margin-bottom: 8px;"><strong>Notes:</strong> ${session.notes}</div>` : ''}
                            ${session.keyHands ? `<div><strong>Key Hands:</strong> ${session.keyHands}</div>` : ''}
                        </div>
                    `;
                }).join('');

                container.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <strong>Recent Session Notes:</strong>
                    </div>
                    ${notesHTML}
                `;
            }

            initChart() {
                const ctx = document.getElementById('bankrollChart').getContext('2d');
                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Bankroll',
                            data: [],
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value;
                                    }
                                }
                            }
                        }
                    }
                });
                this.updateChart();
            }

            updateChart() {
                if (!this.chart) return;

                // Combine sessions and transactions for chart data
                const allEvents = [];
                
                // Add sessions
                this.sessions.forEach(session => {
                    allEvents.push({
                        date: new Date(session.date),
                        amount: session.result,
                        type: 'session',
                        label: `${session.gameType} - ${session.stakes}`
                    });
                });
                
                // Add transactions
                this.transactions.forEach(tx => {
                    let amount = 0;
                    if (tx.type === 'starting_bankroll') amount = tx.amount;
                    else if (tx.type === 'add') amount = tx.amount;
                    else if (tx.type === 'remove') amount = -tx.amount;
                    
                    allEvents.push({
                        date: new Date(tx.date),
                        amount: amount,
                        type: 'transaction',
                        label: tx.reason
                    });
                });
                
                // Sort by date
                allEvents.sort((a, b) => a.date - b.date);
                
                let runningTotal = 0;
                const labels = ['Start'];
                const data = [0];

                allEvents.forEach(event => {
                    runningTotal += event.amount;
                    labels.push(event.date.toLocaleDateString());
                    data.push(runningTotal);
                });

                // Set up datasets array with bankroll data
                const datasets = [{
                    label: 'Bankroll',
                    data: data,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }];

                // Add goal lines
                this.goals.forEach((goal, index) => {
                    const goalData = new Array(labels.length).fill(goal.amount);
                    const colors = ['#e74c3c', '#f39c12', '#9b59b6', '#1abc9c', '#34495e'];
                    const color = colors[index % colors.length];
                    
                    datasets.push({
                        label: `${goal.description} (${this.formatCurrency(goal.amount)})`,
                        data: goalData,
                        borderColor: color,
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0,
                        pointRadius: 0
                    });
                });

                this.chart.data.labels = labels;
                this.chart.data.datasets = datasets;
                this.chart.update();
            }

            formatCurrency(amount) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD'
                }).format(amount);
            }

            async saveData() {
                try {
                    const response = await fetch('/api/data', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.authToken}`
                        },
                        body: JSON.stringify({
                            sessions: this.sessions,
                            goals: this.goals,
                            transactions: this.transactions
                        })
                    });

                    if (response.ok) {
                        // Update last saved timestamp
                        const now = new Date();
                        document.getElementById('lastSaved').textContent = now.toLocaleString();
                        
                        // Update storage status
                        this.updateStorageStatus();
                    } else if (response.status === 401 || response.status === 403) {
                        // Token expired or invalid
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('userEmail');
                        window.location.href = '/';
                        return;
                    } else {
                        throw new Error('Failed to save data');
                    }
                } catch (error) {
                    console.error('Error saving data:', error);
                    alert('Warning: Could not save data to server. Your data may not persist.');
                }
            }

            updateStorageStatus() {
                try {
                    const sessionsSize = JSON.stringify(this.sessions).length;
                    const goalsSize = JSON.stringify(this.goals).length;
                    const transactionsSize = JSON.stringify(this.transactions).length;
                    const totalSize = sessionsSize + goalsSize + transactionsSize;
                    
                    const status = document.getElementById('storageStatus');
                    if (totalSize > 0) {
                        status.textContent = `${(totalSize / 1024).toFixed(1)} KB stored`;
                        status.style.color = '#27ae60';
                    } else {
                        status.textContent = 'No data stored';
                        status.style.color = '#e74c3c';
                    }
                } catch (error) {
                    document.getElementById('storageStatus').textContent = 'Error checking storage';
                    document.getElementById('storageStatus').style.color = '#e74c3c';
                }
            }

            exportData() {
                const userEmail = localStorage.getItem('userEmail') || 'user';
                const data = {
                    sessions: this.sessions,
                    goals: this.goals,
                    transactions: this.transactions,
                    exportDate: new Date().toISOString(),
                    version: '1.0',
                    user: userEmail
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `the-grind-sheet-backup-${userEmail}-${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('Data exported successfully!');
            }

            async importData() {
                const fileInput = document.getElementById('importFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    alert('Please select a file to import.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // Validate the data structure
                        if (!data.sessions || !data.goals || !data.transactions) {
                            throw new Error('Invalid data format');
                        }
                        
                        // Confirm import
                        if (confirm('This will replace all current data. Are you sure you want to continue?')) {
                            this.sessions = data.sessions || [];
                            this.goals = data.goals || [];
                            this.transactions = data.transactions || [];
                            
                            await this.saveData();
                            this.updateStats();
                            this.renderSessions();
                            this.renderGoals();
                            this.renderTransactions();
                            this.updateChart();
                            
                            alert('Data imported successfully!');
                            fileInput.value = ''; // Clear the file input
                        }
                    } catch (error) {
                        alert('Error importing data: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }

        const tracker = new PokerTracker();

        // Logout function
        async function logout() {
            try {
                await fetch('/api/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                localStorage.removeItem('authToken');
                localStorage.removeItem('userEmail');
                window.location.href = '/';
            }
        }
    </script>
</body>
</html>